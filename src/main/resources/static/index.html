<!DOCTYPE html>
<html lang="en" xmlns="">
<head>
    <meta charset="UTF-8">
    <title>웹 채팅</title>
    <style>
        .disabledBox {
            pointer-events: none;
            opacity: 0.5;
        }
        .status
        {
            font-size:  10px;
            color:  #666;
        }
        #Roomlist {
            border: 1px solid #ccc;
            min-height: 40px;
            padding: 8px;
            margin-bottom: 10px;
            background: #f8f8f8;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        #Roomlist button {
            display: block;
            width: 80%;
            padding: 10px 14px;
            font-size: 16px;
            text-align: left;
            border-radius: 6px;
            border: 1px solid #aaa;
            cursor: pointer;
        }
        #Roomlist button:hover {
            background: #e6e6e6;
        }
        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 8px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .msg-system {
            color: #888;
            font-size: 0.9em;
        }
        .msg-error {
            color: #c00;
            font-weight: bold;
        }
        .msg-chat {
            margin: 2px 0;
        }
        .msg-sender {
            font-weight: bold;
        }
        .row {
            margin-bottom: 6px;
        }
        input[type="text"] {
            padding: 4px;
        }
    </style>
</head>
<body>
<div id="status"> 웹소켓 연결 중</div>
<label> 닉네임
    <input id ="nameinput" type = "text" value="web -user">
</label>
<button id="loadRoomsBtn"> 방 목록 새로고침</button>
<div>
    <strong> 방목록</strong>
    <div id="Roomlist">(아직 아무 방도 없습니다)</div>
</div>`
<div>
<strong> 방만들기</strong>
</div>
<div>
    <label>새방이름<input id ="newRoomInput" type="text" placeholder="예 :room-1"/></label>
    <button id = "createroombtn"> 방생성</button>
</div>
<div>
    <strong>현재방 : </strong><span id ="currentroomname"> 없음 </span>
    <button id = "LeaveRoombtn"> 방떠나기</button>
</div>
<div id = "messages"> </div>
<div class ="row">
    <input id="chatinput" type="text" placeholder="메시지 입력후 엔터" style="width: 80%;"/>
    <button id="sendbtn">보내기</button>
</div>
<script>
    let ws = null;
const statusedl =  document.getElementById('status');
const apibase = "http://localhost:8080";
function ConnectWebSocket()
{
    document.getElementById("LeaveRoombtn").disabled =true;
    document.getElementById("sendbtn").disabled =true;
    document.getElementById("sendbtn").disabled =true;
    document.getElementById("chatinput").disabled=true;
    return new Promise((resolve, reject)=>
    {
        ws = new  WebSocket("ws://localhost:8080/ws/chat");
        const to  = setTimeout(()=>{
            ws.close?.();
            reject(new Error("연결타임 아웃"))
        }, 8000);
       ws.onopen = () =>{
           clearTimeout(to);
           resolve(ws);
       };
        ws.onclose = () => {
            statusedl.textContent = "WebSocket 연결 종료됨";
            appendSystem("[INFO] WebSocket 연결 종료");
            ws = null;
        };
       ws.onerror =(e) =>{
           clearTimeout(to);
           reject(e);
       }
        ws.onmessage =(event)=>{
            const msg = JSON.parse(event.data);
            handlemessage(msg);
        }
    })
}
    async function loadroom()
    {
        try
        {
            // 자바 스크립트 restfulapi 호출
            const res = await  fetch(apibase +"/api/Rooms");
            if(!res.ok)
                console.log("방 목록 호출 실패");
            const rooms =await  res.json();
            renderroom(rooms);
        }
        catch (e)
        {
            console.error(e);
            document.getElementById("Roomlist").textContent ="방목록을 가져오는 도중 오류 발생"
        }
    }
    function  renderroom(rooms)
    {
        document.getElementById("Roomlist").innerHTML ="";// 초기화
        if(!rooms||rooms.length ==0)
            document.getElementById("Roomlist").textContent ="현재 현존하는 방이 없습니다";
        rooms.forEach(
            roommid=>{
                const btn =document.createElement("button");
                btn.textContent= roommid;
                btn.addEventListener("click",()=>{
                    joinroom(roommid);
                });
                document.getElementById("Roomlist").appendChild(btn);
            });
    }
    document.getElementById("loadRoomsBtn").addEventListener("click",loadroom);
    function handlemessage(msg)
    {
        console.log("수신 : "+ msg);
        if (msg.type =="Chat") {
            appendChat(msg.sender,msg.content);
        }
        else if (msg.type =="Join") {
            appendSystem(`[INFO] 방 에${nickname}이 입장하였습니다`);
            document.getElementById("createroombtn").disabled =true;
            document.getElementById("loadRoomsBtn").disabled =true;
            document.getElementById("LeaveRoombtn").disabled =false;
            document.getElementById("currentroomname").textContent =roomId;
            document.getElementById("Roomlist").classList.add("disabledBox");
            document.getElementById("sendbtn").disabled =false;
            document.getElementById("sendbtn").disabled =false;
            document.getElementById("chatinput").disabled=false;
            document.getElementById("nameinput").disabled=true;
            document.getElementById("newRoomInput").value ="";
            document.getElementById("newRoomInput").disabled =true;
        }
        else if (msg.type =="CreateAck")
        {
             loadroom(); // 목록 새로고침
            const roomId = document.getElementById("newRoomInput").value.trim();
            document.getElementById("createroombtn").disabled =true;
            document.getElementById("loadRoomsBtn").disabled =true;
            document.getElementById("LeaveRoombtn").disabled =false;
            document.getElementById("currentroomname").textContent =roomId;
            document.getElementById("Roomlist").classList.add("disabledBox");
            document.getElementById("sendbtn").disabled =false;
            document.getElementById("sendbtn").disabled =false;
            document.getElementById("chatinput").disabled=false;
            document.getElementById("nameinput").disabled=true;
            document.getElementById("newRoomInput").value ="";
            document.getElementById("newRoomInput").disabled =true;
        }
        else if (msg.type =="Leave")
        {
            loadroom(); // 목록 새로고침
            document.getElementById("currentroomname").textContent ="현재들어간 방은 없습니다";
            document.getElementById("createroombtn").disabled =false;
            document.getElementById("loadRoomsBtn").disabled =false;
            document.getElementById("LeaveRoombtn").disabled =true;
            document.getElementById("Roomlist").classList.remove("disabledBox");
            document.getElementById("sendbtn").disabled =true;
            document.getElementById("sendbtn").disabled =true;
            document.getElementById("chatinput").disabled=true;
            document.getElementById("nameinput").disabled=false;
            document.getElementById("messages").innerHTML="";
            document.getElementById("newRoomInput").disabled =false;
        }
    }
    async function  createroom ()
    {
        const roomId = document.getElementById("newRoomInput").value.trim();
        const sender = document.getElementById("nameinput").value.trim();
        if (!roomId)
             return;
        try {
            ws.send(JSON.stringify({
                type: "Create",
                roomId,
                sender,
                content:""
            }));
        } catch (e) {
            console.error(e);
        }
    }
    document.getElementById("createroombtn").addEventListener("click",createroom);
    async function  leaveeroom ()
    {
        const roomId = document.getElementById("currentroomname").textContent;
        const sender = document.getElementById("nameinput").value.trim();
        try {
            ws.send(JSON.stringify({
                type: "Leave",
                roomId,
                sender,
                content:""
            }));
        } catch (e) {
            console.error(e);
        }
    }
    document.getElementById("LeaveRoombtn").addEventListener("click",leaveeroom);
    function  sendchat()
    {
        const rid  =document.getElementById("currentroomname").textContent;
        if(rid == "현재들어간 방은 없습니다")
            return;
        // 앞뒤 공백 제거
        const text =document.getElementById("chatinput").value.trim();
        if(!text)
            return;
        const nickname =  document.getElementById("nameinput").value.trim()|| "web-user";
        const  playload ={
            type:"Chat",
            roomId: rid,
            sender: nickname,
            content : text
        };
        ws.send(JSON.stringify(playload));
        document.getElementById("chatinput").value ="";
    }
    document.getElementById("sendbtn").addEventListener("click",sendchat);
    function  appendChat(sender, chat)
    {
        const p = document.createElement("p");
        p.className ="msg-chat";
        const senderSpan =document.createElement("span");
        senderSpan.className ="msg-sender";
        senderSpan.textContent =sender +":";
        p.appendChild(senderSpan);
        p.appendChild(document.createTextNode(chat));
        document.getElementById("messages").appendChild(p);
        document.getElementById("messages").scrollTop= document.getElementById("messages").scrollHeight;
    }
    async function joinroom(roomid)
    {
        const  nickname = nameinput.value||"web-user";
        const  joinmsg ={
            type :"Join",
            roomid: roomid,
            sender: nickname,
            content: ""
        }
        ws.send(JSON.stringify(joinmsg));
        document.getElementById("currentroomname").textContent = roomid;
    }
    function  appendSystem(text)
    {
        const p = document.createElement("p");
        p.className ="msg-system";
        p.textContent =text;
        document.getElementById("messages").appendChild(p);
        document.getElementById("messages").scrollTop =   document.getElementById("messages").scrollHeight;
    }

    window.addEventListener("DOMContentLoaded",()=>{
    try {

        const so = ConnectWebSocket();
        statusedl.textContent = "서버연결 성공"

    }
    catch (e)
    {
        statusedl.textContent = "서버연결실패"
    }

} );

</script>
</body>
</html>